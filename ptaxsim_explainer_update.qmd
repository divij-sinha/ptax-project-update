---
title: "PTAXSIM Tax Explainer"
execute:
  echo: false
  warning: false
format:
  html:
    page-layout: article
    theme: zephyr
---

```{r setup, include=FALSE}
options(tigris_use_cache = TRUE)
options(bitmapType = "cairo")
library(scales)
library(ptaxsim)
library(gt)
library(DBI)
library(RSQLite)
library(RColorBrewer)
library(patchwork)
library(tigris)
library(tidyverse)
library(glue)
library(sf)

source("maps.R")
source("helper_funcs.R")
# set the following variables and run
db_path <- "ptaxsim-2021.0.4.db"
# pin_14 <- "20114070180000" # Hyde Park, Chicago
# pin_14 <- "15361000280000" # Riverside
# pin_14 <- "16291280010000" # Cicero
pin_14 <- "14294070931001" # Wrightwood, Chicago - TIF
# pin_14 <- "16123090200000" # Kinzie - TIF
year <- 2021

ptaxsim_db_conn <- dbConnect(SQLite(), db_path)
```

```{r ptaxsim-data}
pin_details <- lookup_pin(year, pin_14)

render_pin14 <- glue("Parcel ({render_pin(pin_14)})")

pin_exe_details <- pin_details %>%
    select(starts_with("exe")) %>%
    pivot_longer(cols = everything())

pin_exe_total <- pin_exe_details %>%
    pull(value) %>%
    sum()

tax_bill_data <- tax_bill(
    year_vec = year,
    pin_vec = pin_14,
    simplify = F
) %>%
    mutate(agency_total_eav = as.double(agency_total_eav)) %>%
    mutate(agency_major_type = str_to_title(agency_major_type)) %>%
    mutate(tif_agency_name = str_replace_all(tif_agency_name, "TIF - ", "")) %>%
    mutate(tif_agency_name = str_replace_all(tif_agency_name, "RPM1", "Red-Purple Modernisation Phase 1")) %>%
    mutate(tif_agency_name = str_to_title(tif_agency_name)) %>%
    mutate(agency_name = str_to_title(agency_name))

cook_county_max_ext <- tax_bill_data %>%
    filter(agency_major_type == "Cook County") %>%
    slice_max(agency_total_ext) %>%
    mutate(
        agency_tax_amount = label_dol_amt(agency_tax_rate * (eav - exe_total)),
        agency_total_eav = label_dol_amt(agency_total_eav),
        agency_total_ext = label_dol_amt(agency_total_ext),
    )

tif_agency_nums <- tax_bill_data %>%
    select(tif_agency_num) %>%
    filter(!is.na(tif_agency_num)) %>%
    unique() %>%
    pull()

```

```{r ptaxsim-geo-data}
cook_roads <- roads("17", "031")

shp_bnd_pin <- get_shp_bnd_pin(pin_14, year)

shp_buf_pin <- shp_bnd_pin %>%
    st_centroid() %>%
    st_transform(3857) %>%
    st_buffer(650) %>%
    st_transform(4326)

shp_bnd_cook <- get_shp_bnd_cook()

shp_bnd_twn_muni <- tax_bill_data %>%
    filter(agency_minor_type %in% c("MUNI", "TOWNSHIP")) %>%
    select(agency_num, agency_minor_type, agency_name) %>%
    get_shp_twn_muni() %>%
    correct_shp_names() %>%
    mutate(agency_name = as.factor(agency_name))

shp_bnd_all_schools <- tax_bill_data %>%
    filter(agency_major_type == "School") %>%
    pull(agency_num) %>%
    get_shp_all_schools() %>%
    correct_shp_names() %>%
    mutate(agency_name = as.factor(agency_name))

shp_bnd_all_others <- tax_bill_data %>%
    filter(agency_major_type == "Miscellaneous") %>%
    pull(agency_num) %>%
    get_shp_all_others() %>%
    correct_shp_names() %>%
    mutate(agency_name = as.factor(agency_name))

shp_bnd_tifs <- get_shp_tifs(c(tif_agency_nums, "0")) %>%
    left_join(
        tax_bill_data %>%
            select(tif_agency_num, tif_agency_name) %>%
            filter(!is.na(tif_agency_num)) %>%
            unique(),
        by = join_by(AGENCY == tif_agency_num)
    ) %>%
    mutate(agency_name = str_to_title(tif_agency_name))

missing_dis_school <- get_missing_dis(shp_bnd_all_schools, "School")
missing_dis_others <- get_missing_dis(shp_bnd_all_others, "Miscellaneous")

missing_dis <- c(missing_dis_school, missing_dis_others)
```

```{r defaults}
column_colors <- brewer.pal(3, "Pastel1")
column_alpha <- 0.5

map_road_alpha <- 0.3
map_road_lwd <- 0.3
map_fg_fill_alpha <- 0.33
map_bg_fill_alpha <- 0.33
map_color_alpha <- 0.5
map_fg_lwd <- 1.1
map_bg_lwd <- 1.05

map_colors <- c(
    "#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499",
    "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888"
)
map_names <- c(
    render_pin14, "Cook County",
    shp_bnd_twn_muni$agency_name %>% as.character(),
    shp_bnd_all_schools$agency_name %>% as.character(),
    shp_bnd_all_others$agency_name %>% as.character(),
    shp_bnd_tifs$agency_name %>% as.character()
)
map_names <- factor(map_names, levels = map_names, ordered = TRUE)
map_colors <- name_map_colors(map_colors, map_names)
css_colors <- paste0(map_colors, "44")
css_colors <- name_map_colors(css_colors, map_names)
```

## What are property taxes?

Property tax is owed by property owners annually, for both residential and commercial properties. 

These liabilities are decided per `r render_name("property parcel", render_pin14)`, and each parcel is uniquely identifiable with a 14-digit `r render_name("Property Index Number", render_pin14)` or `r render_name("PIN", render_pin14)`

Every `r render_name("PIN", render_pin14)` belongs to multiple tax districts (local government bodies), that need funds for their purposes. 

The Cook County Assessor's Office, the State, and county taxing districts (schools, parks, etc.) work together to calculate fair property taxes for residents.

The property taxes are collected centrally and then distributed to each district

## Breaking the bill down - The tax districts

We will dive into the property bill for `r render_name(render_pin14)` in `r year`. This is the first line item of the bill -

```{r increment-tax-bill-1}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = agency_name),
            cells_body(columns = agency_name),
            cells_row_groups()
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

::: {.column-margin}

> As of FY23, `r render_name(cook_county_max_ext$agency_name,"Cook County")` uses this levy to entirely fund - 
> 
>  - The Election Fund - This in turn funds the Board of Election Commissioners (wholly) and the Cook County Clerk (partially)
>  - The Debt Service Fund - This in turn funds Bond Principal and Interest payments (wholly)
> 
> As of FY23, `r render_name(cook_county_max_ext$agency_name,"Cook County")` also uses property taxes to partially fund - 
> 
>  - General Fund - This in turn pays for the day-to-day operations of the Cook County along with funding the Court System, the Department of Corrections, and the Sheriff Operations
>  - Health Enterprise Fund - This in turn funds Cook County Health
>  - The Capital Projects Fund
>  - Annuity & Benefits Fund
> 
> [Cook County Annual Appropriation, FY23](https://www.cookcountyil.gov/sites/g/files/ywwepo161/files/documents/2023-01/Volume%20I%20-%20Budget%20Overview%20FY23%20Annual%20Appropriation.pdf)

:::

### Cook County tax district

`r render_name("Cook County")` is one of the local government bodies that `r render_name(render_pin14)` falls in.

```{r init-map}
## | fig-cap:
## |   - "Map of Cook County, with the neighborhood and the location of the parcel"

pin_bbox <- st_bbox(shp_bnd_pin)
pin_xlim <- c(pin_bbox$xmin - 0.02, pin_bbox$xmax + 0.02)
pin_ylim <- c(pin_bbox$ymin - 0.015, pin_bbox$ymax + 0.015)

road_map <- ggplot() +
    geom_sf(data = cook_roads, color = alpha("#888888", map_road_alpha), lwd = map_road_lwd)

main_map <- road_map +
    geom_sf(
        data = shp_bnd_cook,
        aes(fill = "Cook County", color = "Cook County"),
        alpha = map_fg_fill_alpha, lwd = map_fg_lwd
    ) +
    geom_rect(
        aes(xmin = pin_xlim[1], xmax = pin_xlim[2], ymin = pin_ylim[1], ymax = pin_ylim[2]),
        color = map_colors[1], fill = NA, lwd = 1.2
    ) +
    geom_sf(
        data = shp_buf_pin,
        alpha = 1,
        lwd = map_fg_lwd,
        fill = "white", color = "white"
    ) +
    geom_sf(
        data = shp_bnd_pin,
        alpha = map_fg_fill_alpha,
        lwd = map_fg_lwd,
        aes(fill = render_pin14, color = render_pin14)
    ) +
    scale_fill_manual(values = map_colors, name = "Extent", drop = FALSE, breaks = map_names) +
    scale_color_manual(values = alpha(map_colors, map_color_alpha), name = "Extent", drop = FALSE, breaks = map_names) +
    theme_void() +
    theme(
        plot.margin = margin(0, 1, 0, 1, unit = "cm"),
        legend.position = c(0.1, 0.6)
    )

inset_map <- main_map +
    geom_sf(data = cook_roads, color = alpha("#888888", map_road_alpha), lwd = map_road_lwd + 0.2) +
    coord_sf(xlim = pin_xlim, ylim = pin_ylim, expand = FALSE) +
    theme_void() +
    guides(colour = "none", fill = "none", alpha = "none")

main_map +
    inset_element(inset_map, -0.1, 0, 0.37, 0.4, align_to = "full")
```

For the purpose of operating `r render_name(cook_county_max_ext$agency_name,"Cook County")`, in `r year`, Cook County needs to collect `r render_name(cook_county_max_ext$agency_total_ext, "Cook County")` in order to provide services.


```{r increment-tax-bill-1-1}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = agency_total_ext),
            cells_body(columns = agency_total_ext)
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

The total taxable value of all properties falling in `r render_name(cook_county_max_ext$agency_name,"Cook County")` make up its **tax base**. 
For `r year`, this was `r render_name(cook_county_max_ext$agency_total_eav, "Cook County")`

```{r increment-tax-bill-1-2}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = agency_total_eav),
            cells_body(columns = agency_total_eav)
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

To divide the cost of services among all property owners, `r render_name(cook_county_max_ext$agency_name,"Cook County")` sets its agency tax rate equal to: 
$$
\mathrm{{Levy \over Base} = Tax \hspace{0.1cm} rate}
$$

Using real numbers, the tax rate equals: 
$$
\mathrm{`r cook_county_max_ext$agency_total_ext` \over `r cook_county_max_ext$agency_total_eav`} = `r label_p_ltx(cook_county_max_ext$agency_tax_rate)`
$$

```{r increment-tax-bill-1-3}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = agency_tax_rate),
            cells_body(columns = agency_tax_rate)
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

#### How much of do you owe Cook County?

As the owner of `r render_name(render_pin14)`, in the year `r year` your property is worth `r render_name(label_dol_amt(pin_details$av*10), render_pin14)`, and your addition to the tax base  of `r render_name(cook_county_max_ext$agency_name,"Cook County")` is `r render_name(label_dol_amt(pin_details$eav), render_pin14)`.

The previously calculated `r render_name("rate", "Cook County")` is then applied to your `r render_name("addition to the tax base", "Cook County")`:

$$
(`r label_dol_amt(pin_details$eav)` * `r label_p_ltx(cook_county_max_ext$agency_tax_rate)`) = `r label_dol_amt(pin_details$eav*cook_county_max_ext$agency_tax_rate)`
$$

This is the total tax amount you owe to `r render_name("Cook County")`

`r if(pin_exe_total == 0) {"<!--"}` 

```{r increment-tax-bill-1-4}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = tax_amt_pre_exe),
            cells_body(columns = tax_amt_pre_exe)
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

This home qualifies for the following exemptions 

```{r exe-det}
pin_exe_details %>%
    filter(value > 0) %>%
    gt() %>%
    cols_label(
        name = "Exemption Type",
        value = "Exemption Amount"
    ) %>%
    fmt_currency(value) %>%
    fmt(columns = name, fns = exe_clean)
```

Summing this, the total exemption value is `r render_name(label_dol_amt(pin_exe_total), render_pin14)`. We multiply this by the tax rate, `r render_name(label_p_ltx(cook_county_max_ext$agency_tax_rate), "Cook County")`, to get `r label_dol_amt(cook_county_max_ext$agency_tax_rate*pin_exe_total)` .  
This is the total tax exemption for the `r render_name("Cook County")`

We can subtract this from the previously calculated tax to get the final tax amount - 

$$
`r label_dol_amt(pin_details$eav*cook_county_max_ext$agency_tax_rate)` - `r label_dol_amt(cook_county_max_ext$agency_tax_rate*pin_exe_total)` = `r cook_county_max_ext$agency_tax_amount`
$$

```{r increment-tax-bill-1-5-exe}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = tax_amt_post_exe),
            cells_body(columns = tax_amt_post_exe)
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

`r if(pin_exe_total == 0) {"-->"}` 

`r if(pin_exe_total != 0) {"<!--"}`
This parcel has no qualified exemptions, and therefore the final owed amount is the same! 

```{r increment-tax-bill-1-5-noexe}
tax_bill_data %>%
    filter(agency_name %in% cook_county_max_ext$agency_name) %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = list(
            cells_column_labels(columns = c(tax_amt_post_exe, tax_amt_pre_exe)),
            cells_body(columns = c(tax_amt_post_exe, tax_amt_pre_exe))
        )
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body()
    )
```

`r if(pin_exe_total != 0) {"-->"}` 

That was the whole first line!

Now, the Cook County also has other tax districts that need their own funds, these are as follows -

```{r increment-tax-bill-2}
tax_bill_data %>%
    filter(agency_major_type == "Cook County") %>%
    render_bill(
        c("Cook County")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(rows = agency_name != cook_county_max_ext$agency_name)
    ) %>%
    tab_style(
        style = cell_fill(color = css_colors["Cook County"]),
        locations = cells_body(rows = agency_name != cook_county_max_ext$agency_name)
    )
```

::: {.column-margin}

> The `r render_name("Forest Preserve District Of Cook County", "Cook County")`, mostly funded by property taxes, further funds, amongst other things, the following -  
> 
>  - The Chicago Zoological Society (Brookefield Zoo)
>  - The Chicago Horticulture Society (Chicago Botanic Garden)
> 
> [FPCC Budget Appropriation, FY23](https://fpdcc.com/downloads/budget/2023/FPCC-2023-Budget-Appropriation-Ordinance-012523.pdf)

:::

But `r render_name("Cook County")` isn't the only local government you must pay taxes to...

### The Township and the Municipality

Illinois is a state that also has a sub-county level of local government known as the township. This could be distinct from the municipality of your parcel!

`r render_name(render_pin14)` belongs to the following - 
```{r town-muni-data}
tax_bill_data %>%
    filter(agency_minor_type %in% c("MUNI", "TOWNSHIP")) %>%
    select(agency_minor_type, agency_name) %>%
    mutate(agency_minor_type = ifelse(agency_minor_type == "MUNI", "MUNICIPALITY", agency_minor_type)) %>%
    gt() %>%
    cols_label(
        agency_minor_type = "Local Government Level",
        agency_name = "Taxing Agency Name"
    ) %>%
    fmt(c(agency_name, agency_minor_type), fns = str_to_title) %>%
    data_color(
        method = "factor",
        columns = agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        apply_to = "fill",
        autocolor_text = FALSE
    )
```

These are often named quite similarly, and are even coterminous in a few cases.

Let's see boundaries of `r render_twn_muni()`, and where the parcel falls in them!

```{r town-muni-map}
## | fig-cap:
## |   - "Map of the municipality/township that the parcel belongs to"

plt_lst <- list()
for (i in 1:nrow(shp_bnd_twn_muni)) {
    plt_lst[[i]] <- map_dist(shp_bnd_twn_muni[i, ])
}

Reduce("+", plt_lst) +
    plot_layout(guides = "collect") &
    theme(legend.position = "bottom")
```

These add other line items to your tax bill...

```{r increment-tax-bill-3}
tax_bill_data %>%
    filter(
        agency_major_type == "Cook County" |
            agency_minor_type == "MUNI" |
            agency_minor_type == "TOWNSHIP"
    ) %>%
    render_bill(
        c("Cook County", "Municipality/Township")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(rows = agency_major_type != "Cook County")
    ) %>%
    data_color(
        method = "factor",
        rows = agency_major_type != "Cook County",
        columns = agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        autocolor_text = FALSE
    )

```

::: {.column-margin}

`r if(!"CITY OF CHICAGO" %in% tax_bill_data$agency_name) {"<!--"}`
> The `r render_twn_muni()` uses the property tax levy for - 
> 
>  - Servicing long term debt (partially)
>  - The Annuity and Benefit Funds for the police, firefighters, municipal employees, and laborers and retirement board employees (partially)
> 
> [City of Chicago, Budget Overview, 2023](https://www.chicago.gov/content/dam/city/depts/obm/supp_info/2023Budget/2023-OVERVIEW.pdf)
`r if(!"CITY OF CHICAGO" %in% tax_bill_data$agency_name) {"-->"}`

`r if("CITY OF CHICAGO" %in% tax_bill_data$agency_name) {"<!--"}`
>  `r render_twn_muni()` could use these funds for generally running city services including water, police, street maintenance etc.
`r if("CITY OF CHICAGO" %in% tax_bill_data$agency_name) {"-->"}`

:::

Similarly to `r render_name("Cook County")`, 
there also exist other tax districts in 
`r render_twn_muni()`, these are as follows -

```{r increment-tax-bill-4, echo=F}
tax_bill_data %>%
    filter(
        agency_major_type %in% c("Cook County", "Municipality/Township")
    ) %>%
    render_bill(
        c("Cook County", "Municipality/Township")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(
            rows =
                (agency_major_type != "Cook County") &
                    !(agency_name %in% (tax_bill_data %>%
                        filter(agency_minor_type %in% c("MUNI", "TOWNSHIP")) %>%
                        pull(agency_name))
                    )
        )
    ) %>%
    data_color(
        method = "factor",
        rows = (agency_major_type != "Cook County") &
            !(agency_name %in% (tax_bill_data %>%
                filter(agency_minor_type %in% c("MUNI", "TOWNSHIP")) %>%
                pull(agency_name))
            ),
        columns = agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        autocolor_text = FALSE
    )
```

::: {.column-margin}

`r if(!"City Of Chicago" %in% tax_bill_data$agency_name) {"<!--"}`
> Here, there is a more direct funding of the Chicago Public Library System through the City of Chicago Library Fund, and of the Chicago Public School System through the City Of Chicago School Building & Improvement Fund.
`r if(!"City Of Chicago" %in% tax_bill_data$agency_name) {"-->"}`

`r if("City Of Chicago" %in% tax_bill_data$agency_name) {"<!--"}`
> Here, there is a more direct funding of other systems in a municipality like its libraries, roads, etc.
`r if("City Of Chicago" %in% tax_bill_data$agency_name) {"-->"}`

:::

### School Tax Districts

Now, let's look at all the school districts that this PIN falls under.

```{r school-map-indi}
## | fig-cap:
## |   - "Map of the individual school districts"

plt_lst <- list()
for (i in 1:nrow(shp_bnd_all_schools)) {
    plt_lst[[i]] <- map_dist(shp_bnd_all_schools[i, ])
}

Reduce("+", plt_lst) +
    plot_layout(guides = "collect") &
    theme(legend.position = "bottom")
```

Each of these school districts also adds a line item to the bill -

```{r increment-tax-bill-5}
tax_bill_data %>%
    filter(
        agency_major_type %in% c("Cook County", "Municipality/Township", "School")
    ) %>%
    render_bill(
        c("Cook County", "Municipality/Township", "School")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(rows = agency_major_type == "School")
    ) %>%
    data_color(
        method = "factor",
        rows = agency_major_type == "School",
        columns = agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        autocolor_text = FALSE
    )
```

::: {.column-margin}

> Generally, these districts fund the local elementary, middle and high schools, along with community colleges in the area.
>
`r if(!"Board Of Education" %in% tax_bill_data$agency_name) {"<!--"}`
> The `r render_name("Board Of Education")` is partially funded by property taxes and runs the Chicago Public Schools system, a K-12 system in the City of Chicago.
> 
> [Chicago Public Schools, Revenue, 2023](https://www.cps.edu/about/finance/budget/budget-2023/revenue/)
`r if(!"Board Of Education" %in% tax_bill_data$agency_name) {"-->"}`
`r if(!"Chicago Community College District 508" %in% tax_bill_data$agency_name) {"<!--"}`
> `r render_name("Chicago Community College District 508")` is partially funded by property taxes and runs the City Colleges of Chicago, a system of seven accredited colleges across the City of Chicago
> 
> [City Colleges of Chicago, Final Budget, FY 22](https://www.ccc.edu/departments/Documents/Finance%20Documents/FY2022%20Final%20Annual%20Operating%20Budget%20Book.pdf)
`r if(!"Chicago Community College District 508" %in% tax_bill_data$agency_name) {"-->"}`

:::

### Other districts 

Similarly, there are a few other miscellaneous districts

```{r others-map-indi}
## | fig-cap:
## |   - "Map of the individual other misc districts"

plt_lst <- list()
for (i in 1:nrow(shp_bnd_all_others)) {
    plt_lst[[i]] <- map_dist(shp_bnd_all_others[i, ])
}

Reduce("+", plt_lst) +
    plot_layout(guides = "collect") &
    theme(legend.position = "bottom")
```

All of these also add their own line items to the tax bill, and this finally ends up in our complete tax bill!

```{r increment-tax-bill-6}
tax_bill_data %>%
    render_bill(
        c("Cook County", "Municipality/Township", "School", "Miscellaneous")
    ) %>%
    tab_style(
        style = cell_text(weight = "bold"),
        locations = cells_body(rows = !(agency_major_type %in% c("Cook County", "Municipality/Township", "School")))
    ) %>%
    data_color(
        method = "factor",
        rows = !(agency_major_type %in% c("Cook County", "Municipality/Township", "School")),
        columns = agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        autocolor_text = FALSE
    )
```

::: {.column-margin}

`r if(!"Metro Water Reclamation District Of Greater Chicago" %in% tax_bill_data$agency_name) {"<!--"}`
> The `r render_name("Metro Water Reclamation District Of Greater Chicago")` is funded substantially by property taxes, and it uses the funds towards sewage, wastewater, and stormwater management. It maintains the "TARP" underneath Chicago, and reversed the flow of the rivers away from Lake Michigan.
`r if(!"Metro Water Reclamation District Of Greater Chicago" %in% tax_bill_data$agency_name) {"-->"}`
`r if(!"Chicago Park District" %in% tax_bill_data$agency_name) {"<!--"}`
> The `r render_name("Chicago Park District")` is also substantially funded by property taxes. Along with running all Chicago Park District parks across the City of Chicago, it further funds the operations of -
> 
>  - The maintenance and upkeep of Soldier Field and, Northerly Island
>  - Remittance to Lincoln Park Zoo, and Shedd Aquarium
>  - Remittance to museums located in CPD land including Adler Planetarium, The Art Institute of Chicago, Chicago History Museum, DuSable Museum of African American History, The Field Museum, Museum of Contemporary Art, and Museum of Science and Industry amongst others
>   - The Garfield Park Conservatory Alliance 
>   - The management of MLK Center
`r if(!"Chicago Park District" %in% tax_bill_data$agency_name) {"-->"}`

:::

`r if(!isTRUE(nchar(tif_agency_nums) > 0)) {"<!--"}`

## TIFs!

TIFs or Tax Increment Financing districts are special vehicles that redirect your funding towards other purposes

Your parcel - `r render_name(render_pin14)` - belongs to the following TIFs - 

```{r tif-data}
tax_bill_data %>%
    select(tif_agency_name, tif_share) %>%
    unique() %>%
    gt() %>%
    cols_label(
        tif_agency_name = "TIF Name",
        tif_share = "Share of TIF"
    ) %>%
    fmt(tif_agency_name, fns = str_to_title) %>%
    fmt_percent(tif_share) %>%
    data_color(
        method = "factor",
        columns = tif_agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        apply_to = "fill",
        autocolor_text = FALSE
    )

```

```{r tif-map-indi, eval = isTRUE(nchar(tif_agency_nums) > 0)}
## | fig-cap:
## |   - "Map of the TIFs"

plt_lst <- list()
for (i in 1:nrow(shp_bnd_tifs)) {
    plt_lst[[i]] <- map_dist(shp_bnd_tifs[i, ])
}

Reduce("+", plt_lst) +
    plot_layout(guides = "collect") &
    theme(legend.position = "bottom")
```

The way TIFs work is by funnelling a share of all your (post-exemption) taxes to the special purpose of the TIF.  

The share of the TIF differs every year. It works by freezing the tax base of the Municipality to the year that the TIF was enacted, and any increase in the Tax Base is redirected to the TIF.  

This means that for `r render_name(cook_county_max_ext$agency_name, "Cook County")`, the following amount is siphoned off to the TIF 

$$
`r cook_county_max_ext$agency_tax_amount` * `r label_p_ltx(cook_county_max_ext$tif_share)` = `r label_dol_amt(sum(cook_county_max_ext$final_tax_to_tif + cook_county_max_ext$rpm_tif_to_dist))`
$$

Similarly, each tax district contributes - 

```{r tif-bill-1, eval = isTRUE(nchar(tif_agency_nums) > 0)}
tax_bill_data %>%
    mutate(final_tif_tax = final_tax_to_tif + rpm_tif_to_dist) %>%
    mutate(final_dist_tax = tax_amt_post_exe - final_tif_tax) %>%
    select(agency_name, tax_amt_post_exe, tif_share, final_tif_tax, final_dist_tax, agency_major_type) %>%
    group_by(agency_major_type) %>%
    gt() %>%
    cols_label(
        agency_name = "Tax District",
        tax_amt_post_exe = "Final Tax Owed",
        tif_share = "TIF Share",
        final_tif_tax = "Amount directed to TIF",
        final_dist_tax = "Amount directed to Agency"
    ) %>%
    row_group_order(c("Cook County", "Municipality/Township", "School", "Miscellaneous")) %>%
    fmt(agency_name, fns = str_to_title) %>%
    fmt_currency(c(final_tif_tax, final_dist_tax, tax_amt_post_exe)) %>%
    fmt_percent(tif_share) %>%
    tab_options(row_group.as_column = T) %>%
    grand_summary_rows(
        fns = list(
            label = "Amount directed to TIF",
            id = "sum",
            fn = "sum"
        ),
        columns = final_tif_tax,
        fmt = ~ fmt_currency(., rows = "sum")
    ) %>%
    tab_style(
        style = list(
            cell_fill(color = css_colors[shp_bnd_tifs$agency_name])
        ),
        locations = list(
            cells_body(columns = final_tif_tax),
            cells_column_labels(columns = final_tif_tax),
            cells_grand_summary(columns = final_tif_tax)
        )
    ) %>%
    tab_style(
        style = list(
            cell_text(weight = "bold")
        ),
        locations = list(
            cells_body(columns = final_dist_tax),
            cells_column_labels(columns = final_dist_tax),
            cells_stub_grand_summary(),
            cells_grand_summary(columns = final_tif_tax)
        )
    )
```

The total property tax diverted to the `r render_name(shp_bnd_tifs$agency_name)` is `r render_name(label_d(sum(tax_bill_data$final_tax_to_tif, tax_bill_data$rpm_tif_to_dist)) ,shp_bnd_tifs$agency_name)`

The column **"Amount directed to Agency"** is the share of your total property tax contributions that actually go to said agencies!

`r if(!"030210900" %in% tif_agency_nums) {"<!--"}`
### Special TIF 

The Red-Purple Modernisation TIF is a special one!  

Of it's collections, it redirects some money back to the districts, and a chunk of money to the Chicago Public Schools! 

In our case, of the `r render_name(label_d(sum(tax_bill_data$final_tax_to_tif, tax_bill_data$rpm_tif_to_dist)) ,shp_bnd_tifs$agency_name)` directed to the TIF -  

 - `r render_name(label_d(sum(tax_bill_data$rpm_tif_to_rpm)), shp_bnd_tifs$agency_name)` - To the `r render_name(shp_bnd_tifs$agency_name)`
 - `r render_name(label_d(sum(tax_bill_data$rpm_tif_to_cps)), "Board Of Education")` - To the `r render_name("Chicago Public Schools", "Board Of Education")`
 - `r label_d(sum(tax_bill_data$rpm_tif_to_dist))` - Back to the districts 

Therefore, the final tax collection for each tax district (adding back the share for the `r render_name("Chicago Public Schools", "Board Of Education")`, and the amount back to the other districts) looks as follows - 

```{r tif-final, eval = isTRUE(nchar(tif_agency_nums) > 0)}
tax_bill_data %>%
    mutate(final_tif_tax = final_tax_to_tif + rpm_tif_to_dist) %>%
    mutate(final_dist_tax = tax_amt_post_exe - final_tif_tax) %>%
    mutate(rpm_tif_to_dist = ifelse(agency_name == "Board Of Education", sum(tax_bill_data$rpm_tif_to_cps), rpm_tif_to_dist)) %>%
    mutate(total_tax_agency = final_dist_tax + rpm_tif_to_dist) %>%
    select(agency_name, final_dist_tax, agency_major_type, rpm_tif_to_dist, total_tax_agency) %>%
    group_by(agency_major_type) %>%
    gt() %>%
    cols_label(
        agency_name = "Tax District",
        final_dist_tax = "Amount directed to Agency",
        rpm_tif_to_dist = "TIF back to Agency",
        # rpm_tif_back = "TIF to CPS",
        total_tax_agency = "Total amount to Agency"
    ) %>%
    row_group_order(c("Cook County", "Municipality/Township", "School", "Miscellaneous")) %>%
    fmt(agency_name, fns = str_to_title) %>%
    fmt_currency(c(final_dist_tax, rpm_tif_to_dist, total_tax_agency)) %>%
    tab_options(row_group.as_column = T) %>%
    tab_style(
        style = list(
            cell_text(weight = "bold")
        ),
        locations = list(
            cells_body(columns = total_tax_agency),
            cells_column_labels(columns = total_tax_agency)
        )
    )
```

`r if((!isTRUE(nchar(tif_agency_nums) > 0)) || (!"030210900" %in% tif_agency_nums)) {"-->"}`


## Final Tax Bill

This is your final, total tax bill for `r render_name(render_pin14)` for the year `r year`

```{r}
tax_bill_data %>%
    replace(is.na(.), 0) %>%
    mutate(final_tax = ifelse(agency_name == "Board Of Education", final_tax_to_dist + sum(tax_bill_data$rpm_tif_to_cps), final_tax_to_dist)) %>%
    add_row(
        agency_major_type = "TIF",
        agency_name = tax_bill_data %>%
            select(tif_agency_name) %>%
            unique() %>% pull(),
        final_tax = ifelse(sum(tax_bill_data$rpm_tif_to_rpm) > 0, sum(tax_bill_data$rpm_tif_to_rpm), sum(tax_bill_data$final_tax_to_tif))
    ) %>%
    filter(final_tax > 0) %>%
    select(agency_major_type, agency_name, final_tax) %>%
    group_by(agency_major_type) %>%
    gt() %>%
    grand_summary_rows(
        fns = list(
            label = "Total Tax Owed",
            id = "sum",
            fn = "sum"
        ),
        columns = final_tax,
        fmt = ~ fmt_currency(., rows = "sum")
    ) %>%
    cols_label(
        agency_name = "Tax District",
        final_tax = "Tax amount"
    ) %>%
    fmt_currency(final_tax) %>%
    data_color(
        method = "factor",
        columns = agency_name,
        target_columns = everything(),
        fn = css_get_colors,
        apply_to = "fill",
        autocolor_text = FALSE
    ) %>%
    tab_style(
        style = list(
            cell_text(weight = "bold")
        ),
        locations = list(
            cells_stub_grand_summary(),
            cells_grand_summary()
        )
    ) %>%
    tab_options(row_group.as_column = T)
```

`r if(length(missing_dis) > 0) {paste0("_NOTE: The following districts were not shown on the maps above - ", glue("{paste(str_to_title(missing_dis), collapse = '; ')}"), "_")}`


<!-- 
text for tax base 
map changes
flow - school -> muni/twn -> other -> county -> tif
exemption bottom
-->